name: Build Moonlander Firmware

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Config
      uses: actions/checkout@v4
      with:
        path: config

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install QMK CLI
      run: |
        python -m pip install --upgrade pip
        pip install qmk

    - name: Checkout QMK Firmware
      uses: actions/checkout@v4
      with:
        repository: zsa/qmk_firmware
        ref: firmware25
        path: qmk_firmware
        submodules: recursive

    - name: Install QMK dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi libnewlib-arm-none-eabi

    - name: Copy Keymap
      run: |
        mkdir -p qmk_firmware/keyboards/zsa/moonlander/reva/keymaps/latest
        # Copy contents of src from the checked out config (which is the submodule repo itself now)
        cp -r config/src/* qmk_firmware/keyboards/zsa/moonlander/reva/keymaps/latest/

    - name: Compile Firmware
      run: |
        cd qmk_firmware
        qmk compile -kb zsa/moonlander/reva -km latest

    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: moonlander_firmware
        path: qmk_firmware/*.bin